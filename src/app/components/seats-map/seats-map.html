<p-dialog
  [(visible)]="seatDialogVisible"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '22rem' }"
  header="בחירת מושב"
  (onHide)="closeSeatDialog()"
  [draggable]="false"
  [resizable]="false"
>
  @if (selectedSeat) {
    <div class="flex flex-column gap-3" dir="rtl">
      <p><strong>יציע:</strong> {{ selectedSeat.section }}</p>
      <p><strong>שורה:</strong> {{ selectedSeat.row + 1 }}</p>
      <p><strong>כיסא:</strong> {{ selectedSeat.col + 1 }}</p>
      <p><strong>מחיר:</strong> {{ selectedSeatPrice != null ? selectedSeatPrice + ' ₪' : '—' }}</p>
      @if (seatConflictMessage) {
        <p class="text-red-600 font-medium">{{ seatConflictMessage }}</p>
      }
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="ביטול" severity="secondary" (click)="closeSeatDialog()" [disabled]="savingSeat"></p-button>
    <p-button label="שמור" (click)="confirmSeatChoice()" [loading]="savingSeat" [disabled]="savingSeat"></p-button>
  </ng-template>
</p-dialog>

<div class="seats-map-wrapper" dir="rtl">
  @if (show) {
    <div class="seats-card">
      @if (cartItems.length > 0 && remainingSeconds !== null) {
        <div class="countdown-bar">
          <span class="countdown-label">זמן שנותר עד שחרור מושב:</span>
          <span class="countdown-value">{{ formatCountdown(remainingSeconds) }}</span>
        </div>
      }
      <div class="seats-layout">
        <section class="section left-bal">
          <h4 class="section-title">יציע שמאל</h4>
          <div class="section-grid section-grid-skew-left">
            @for (row of show.leftBalMap.map; track $index) {
              <div class="seat-row">
                @for (seat of row; track $index) {
                  <button
                    class="seat-button"
                    [class.seat-available]="getSeatState(seat) === 'available'"
                    [class.seat-in-cart]="getSeatState(seat) === 'in-cart'"
                    [class.seat-disabled]="getSeatState(seat) === 'unavailable'"
                    [class.seat-pending]="isPending(seat)"
                    [disabled]="getSeatState(seat) !== 'available' || isPending(seat)"
                    [title]="getSeatTitle(seat, show.leftBalMap.price)"
                    type="button"
                    (click)="onSeatClick(seat)"
                  ></button>
                }
              </div>
            }
          </div>
        </section>

        <section class="section center-bal">
          <h4 class="section-title">יציע מרכז</h4>
          <div class="section-grid section-grid-curve-top">
            @for (row of show.centerBalMap.map; track $index) {
              <div class="seat-row">
                @for (seat of row; track $index) {
                  <button
                    class="seat-button"
                    [class.seat-available]="getSeatState(seat) === 'available'"
                    [class.seat-in-cart]="getSeatState(seat) === 'in-cart'"
                    [class.seat-disabled]="getSeatState(seat) === 'unavailable'"
                    [class.seat-pending]="isPending(seat)"
                    [disabled]="getSeatState(seat) !== 'available' || isPending(seat)"
                    [title]="getSeatTitle(seat, show.centerBalMap.price)"
                    type="button"
                    (click)="onSeatClick(seat)"
                  ></button>
                }
              </div>
            }
          </div>
        </section>

        <section class="section right-bal">
          <h4 class="section-title">יציע ימין</h4>
          <div class="section-grid section-grid-skew-right">
            @for (row of show.rightBalMap.map; track $index) {
              <div class="seat-row">
                @for (seat of row; track $index) {
                  <button
                    class="seat-button"
                    [class.seat-available]="getSeatState(seat) === 'available'"
                    [class.seat-in-cart]="getSeatState(seat) === 'in-cart'"
                    [class.seat-disabled]="getSeatState(seat) === 'unavailable'"
                    [class.seat-pending]="isPending(seat)"
                    [disabled]="getSeatState(seat) !== 'available' || isPending(seat)"
                    [title]="getSeatTitle(seat, show.rightBalMap.price)"
                    type="button"
                    (click)="onSeatClick(seat)"
                  ></button>
                }
              </div>
            }
          </div>
        </section>

        <section class="section hall">
          <h4 class="section-title">אולם</h4>
          <div class="section-grid section-grid-curve-bottom">
            @for (row of show.hallMap.map; track $index; let i = $index) {
              <div class="seat-row" [class.row-inner]="i < 3" [class.row-outer]="i >= 7">
                @for (seat of row; track $index) {
                  <button
                    class="seat-button"
                    [class.seat-available]="getSeatState(seat) === 'available'"
                    [class.seat-in-cart]="getSeatState(seat) === 'in-cart'"
                    [class.seat-disabled]="getSeatState(seat) === 'unavailable'"
                    [class.seat-pending]="isPending(seat)"
                    [disabled]="getSeatState(seat) !== 'available' || isPending(seat)"
                    [title]="getSeatTitle(seat, show.hallMap.price)"
                    type="button"
                    (click)="onSeatClick(seat)"
                  ></button>
                }
              </div>
            }
          </div>
        </section>
      </div>
    </div>
  }
</div>